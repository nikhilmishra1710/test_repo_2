name: Jira Release on Tag

on:
  workflow_run:
    workflows: ["Auto Tag and Release on Merge"]
    types:
      - completed

jobs:
  jira_release:
    if: ${{ github.event.workflow_run.conclusion == 'success' }}
    runs-on: ubuntu-latest

    steps:
      - name: Set environment variables from workflow_run
        run: |
          echo "NEW_TAG=${{ github.event.workflow_run.outputs.NEW_TAG }}" >> $GITHUB_ENV
          echo "PR_TITLE=${{ github.event.workflow_run.head_commit.message }}" >> $GITHUB_ENV

      - name: Create Jira release version
        env:
          JIRA_BASE_URL: ${{ secrets.JIRA_URL }}
          JIRA_PROJECT: ${{ secrets.JIRA_PROJECT_KEY }}
          JIRA_USER: ${{ secrets.JIRA_EMAIL }}
          JIRA_TOKEN: ${{ secrets.JIRA_TOKEN }}
          NEW_TAG: ${{ env.NEW_TAG }}
        run: |
          echo "Creating Jira release for tag $NEW_TAG"

          jq -n \
            --arg project "$JIRA_PROJECT" \
            --arg name "$NEW_TAG" \
            --arg desc "Release created from GitHub tag $NEW_TAG" \
            '{
              name: $name,
              description: $desc,
              released: true,
              project: $project
            }' > version.json

          RESPONSE=$(curl -s -o response.json -w "%{http_code}" \
            -u "$JIRA_USER:$JIRA_TOKEN" \
            -H "Content-Type: application/json" \
            -X POST \
            --data @version.json \
            "$JIRA_BASE_URL/rest/api/3/version")

          echo "HTTP Response: $RESPONSE"
          cat response.json

      - name: Extract Jira version ID
        run: |
          VERSION_ID=$(jq -r '.id' response.json)
          echo "VERSION_ID=$VERSION_ID" >> $GITHUB_ENV

      - name: Link Jira issues to release
        env:
          JIRA_BASE_URL: ${{ secrets.JIRA_URL }}
          JIRA_USER: ${{ secrets.JIRA_EMAIL }}
          JIRA_TOKEN: ${{ secrets.JIRA_TOKEN }}
          VERSION_ID: ${{ env.VERSION_ID }}
          PR_TITLE: ${{ env.PR_TITLE }}
          JIRA_PROJECT: ${{ secrets.JIRA_PROJECT_KEY }}
        run: |
          echo "Looking for Jira issue keys in PR title: $PR_TITLE"
          ISSUE_KEYS=$(echo "$PR_TITLE" | grep -oE "$JIRA_PROJECT-[0-9]+" || true)
          echo "Issue keys: $ISSUE_KEYS"
          for ISSUE in $ISSUE_KEYS; do
            echo "Linking $ISSUE to version $VERSION_ID"
            curl -s -o link_response.json -w "%{http_code}" \
              -u "$JIRA_USER:$JIRA_TOKEN" \
              -H "Content-Type: application/json" \
              -X PUT \
              --data "{\"update\": {\"fixVersions\": [{\"add\": {\"id\": \"$VERSION_ID\"}}]}}" \
              "$JIRA_BASE_URL/rest/api/3/issue/$ISSUE"
          done
